name: hubs
services:
  hubs:
    container_name: hubs
    image: ${OVERRIDE_HUBS_IMAGE:-hubsfoundation/hubs:${CONTAINER_TAG:-stable-latest}}
    restart: unless-stopped
    networks:
      - hubs
    ports:
      - '8080:8080'   # development only
    environment:
      turkeyCfg_thumbnail_server: cors.${HUB_DOMAIN:?error}/nearspark
      turkeyCfg_base_assets_path: https://assets.${HUB_DOMAIN:?error}/hubs/
      turkeyCfg_non_cors_proxy_domains: ${HUB_DOMAIN:?error},assets.${HUB_DOMAIN:?error},demo.hubsfoundation.org,*.demo.hubsfoundation.org
      turkeyCfg_reticulum_server: ${HUB_DOMAIN:?error}
      turkeyCfg_cors_proxy_server: cors.${HUB_DOMAIN:?error}
      turkeyCfg_shortlink_domain: ${HUB_DOMAIN:?error}
      turkeyCfg_tier: p1
    healthcheck:
      test: ['CMD', 'curl', '-fk', 'https://hubs:8080/healthz']

  spoke:
    container_name: spoke
    image: ${OVERRIDE_SPOKE_IMAGE:-hubsfoundation/spoke:${CONTAINER_TAG:-stable-latest}}
    restart: unless-stopped
    networks:
      - hubs
    ports:
      - '8081:8080'   # development only
    #      - '9090:9090'   # development only
    environment:
      turkeyCfg_thumbnail_server: cors.${HUB_DOMAIN:?error}/nearspark
      turkeyCfg_base_assets_path: https://assets.${HUB_DOMAIN:?error}/spoke/
      turkeyCfg_non_cors_proxy_domains: ${HUB_DOMAIN:?error},assets.${HUB_DOMAIN:?error},demo.hubsfoundation.org,*.demo.hubsfoundation.org
      turkeyCfg_reticulum_server: ${HUB_DOMAIN:?error}
      turkeyCfg_cors_proxy_server: cors.${HUB_DOMAIN:?error}
      turkeyCfg_shortlink_domain: ${HUB_DOMAIN:?error}
      turkeyCfg_hubs_server: ${HUB_DOMAIN:?error}
    healthcheck:
      test: ['CMD', 'curl', '-fk', 'https://spoke:8080/healthz']

  pgsql:
    container_name: pgsql
    image: ${OVERRIDE_POSTGRES_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/postgres:${CONTAINER_TAG:-stable-latest}}
    restart: unless-stopped
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    networks:
      - hubs
    ports:
      - '5432:5432'   # development only
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASS:-123456}
      POSTGRES_DB: ${DB_NAME:-retdb}
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', '${DB_USER:-postgres}', '-d', '${DB_NAME:-retdb}']

  pgbouncer:
    container_name: pgbouncer
    image: ${OVERRIDE_PGBOUNCER_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/pgbouncer:${CONTAINER_TAG:-stable-latest}}
    depends_on:
      pgsql: { condition: service_healthy, restart: true }
    restart: unless-stopped
    networks:
      - hubs
    ports:
      - '5433:5432'   # development only
#      - '6432:6432'   # development only
    environment: &pgbouncer-environment
      MAX_CLIENT_CONN: '10000'
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASS:-123456}
      PGPASSWORD:  ${DB_PASS:-123456}
      DB_HOST: pgsql
    healthcheck: &pgbouncer-healthcheck
      test: ['CMD', 'psql', '-h', 'localhost', '-U', '${DB_USER:-postgres}', '-c', 'SELECT 1']

  pgbouncer-t:
    container_name: pgbouncer-t
    image: ${OVERRIDE_PGBOUNCER_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/pgbouncer:${CONTAINER_TAG:-stable-latest}}
    depends_on:
      pgsql: { condition: service_healthy, restart: true }
    restart: unless-stopped
    networks:
      - hubs
    ports:
      - '5434:5432'   # development only
#      - '6432:6432'   # development only
    environment:
      <<: *pgbouncer-environment
      POOL_MODE: transaction
    healthcheck: *pgbouncer-healthcheck

  postgrest:
    container_name: postgrest
    image: ${OVERRIDE_POSTGREST_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/postgrest:${CONTAINER_TAG:-stable-latest}}
    restart: unless-stopped
    depends_on:
      pgbouncer: { condition: service_healthy, restart: true }
    networks:
      - hubs
    #    network_mode: service:reticulum
    ports:
      - '3000:3000'
    environment:
      PGRST_LOG_LEVEL: info
      PGRST_DB_SCHEMA: ret0_admin
      PGRST_DB_ANON_ROLE: ${DB_USER:-postgres}
      PGRST_DB_URI: 'postgres://${DB_USER:-postgres}:${DB_PASS:-123456}@pgbouncer/${DB_NAME:-retdb}'
  #    healthcheck:
  #      test: ['CMD', 'postgrest', '--ready']   # when updated to post-2025-09-28

  ret:
    container_name: ret
    image: ${OVERRIDE_RETICULUM_IMAGE:-hubsfoundation/reticulum:${CONTAINER_TAG:-stable-latest}}
    restart: unless-stopped
    privileged: true
    depends_on:
      hubs: { condition: service_healthy }
#      spoke: { condition: service_healthy, required: false }
      pgbouncer: { condition: service_healthy }
      pgbouncer-t: { condition: service_healthy }
      postgrest: { condition: service_started }
    networks:
      - hubs
    ports:
      - '4000:4000'   # HTTPS (development only)
      - '4001:4001'   # HTTP (development only)
      - '9100:9100'
    volumes:
      - reticulum-storage:/storage
      - ./reticulum-config:/home/ret
    environment:
      POD_IP: reticulum
      POD_NAME: reticulum
      turkeyCfg_POD_NS: hcce   # only for substitution in config.toml.template?
      turkeyCfg_NODE_COOKIE: ${NODE_COOKIE:?error}
      turkeyCfg_HUB_DOMAIN: ${HUB_DOMAIN:?error}
      turkeyCfg_DOMAIN: ${HUB_DOMAIN:?error}
      turkeyCfg_DB_USER: ${DB_USER:-postgres}
      turkeyCfg_DB_PASS: ${DB_PASS:-123456}
      turkeyCfg_DB_NAME: ${DB_NAME:-retdb}
      turkeyCfg_DB_HOST: ${DB_HOST:-pgbouncer}
      turkeyCfg_DB_HOST_T: ${DB_HOST_T:-pgbouncer-t}
      turkeyCfg_GUARDIAN_KEY: ${GUARDIAN_KEY:?error}
      turkeyCfg_PHX_KEY: ${PHX_KEY:?error}
      turkeyCfg_SMTP_SERVER: ${SMTP_SERVER:?error}
      turkeyCfg_SMTP_PORT: ${SMTP_PORT:?error}
      turkeyCfg_SMTP_USER: ${SMTP_USER:?error}
      turkeyCfg_SMTP_PASS: ${SMTP_PASS:?error}
      turkeyCfg_ADM_EMAIL: ${ADM_EMAIL:?error}
      turkeyCfg_SKETCHFAB_API_KEY: ${SKETCHFAB_API_KEY:-}
      turkeyCfg_IMG_PROXY: nearspark
      turkeyCfg_TENOR_API_KEY: ${TENOR_API_KEY:-}
      turkeyCfg_YTDL_HOST: http://ytdl:5000
      turkeyCfg_PHOTOMNEMONIC: http://photomnemonic:5000
      turkeyCfg_SPEELYCAPTOR: http://speelycaptor:5000
      turkeyCfg_STORAGE_QUOTA_GB: 1000
    healthcheck:
      test: ['CMD', 'wget', '-qO', '-', '-S', 'ret:4001/health']

  nginx:
    image: nginx:1.29-alpine
    container_name: nginx
    restart: unless-stopped
    depends_on:
      hubs: { condition: service_healthy }
      spoke: { condition: service_healthy, required: false }
      ret: { condition: service_healthy }
#      dialog: { condition: service_healthy, required: false }
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-conf:/etc/nginx/conf.d
      - ./single:/var/www/single:ro
      - ./support:/var/www/support:ro
      - acme-challenge:/var/www/acme-challenge:ro
      - certbot-etc:/etc/letsencrypt:ro
    networks:
      - hubs
    environment:
      HUB_DOMAIN: ${HUB_DOMAIN:?error}
    command: |
      /bin/sh -c "
      for file in /etc/nginx/conf.d/*.template; do
        envsubst '$$HUB_DOMAIN' < $$file > $${file%.template}.conf;
      done && exec nginx -g 'daemon off;'"
    healthcheck:
      test: ['CMD', 'curl', 'http://127.0.0.1/healthz']
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 10s

#  nearspark:
#    container_name: nearspark
#    image: ${OVERRIDE_NEARSPARK_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/nearspark:${CONTAINER_TAG:-stable-latest}}
#    restart: unless-stopped
#    networks:
#      - hubs
#    ports:
#      - '5000:5000'
#    healthcheck:
#      test: ['CMD', 'nc', '-zv', 'nearspark', '5000']
##      test: ['CMD', 'wget', '-qO', '-', '-S', 'nearspark:5000/thumbnail/']
#
#  photomnemonic:
#    container_name: photomnemonic
#    image: ${OVERRIDE_PHOTOMNEMONIC_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/photomnemonic:${CONTAINER_TAG:-stable-latest}}
#    restart: unless-stopped
#    networks:
#      - hubs
#    ports:
#      - '5001:5000'
#    healthcheck:
#      test: ['CMD', 'curl', '-f', 'http://photomnemonic:5000/_healthz']
#
#  dialog:
#    container_name: dialog
#    image: ${OVERRIDE_DIALOG_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/dialog:${CONTAINER_TAG:-stable-latest}}
#    restart: unless-stopped
#    #    network_mode: host
#    networks:
#      - hubs
#    ports:
#      - '4443:4443'
#      - '7000:7000'
#      - '40000-40050:40000-40050'
#      - '40000-40050:40000-40050/udp'
#    healthcheck:   # Mediasoup 5 has a built-in healthcheck
##      test: ['CMD', 'curl', '-fk', 'https://dialog:4443/']
#      test: ['CMD', 'curl', '-f', 'http://dialog:7000/meta']
#
#  coturn:
#    container_name: coturn
#    image: ${OVERRIDE_COTURN_IMAGE:-${Container_Dockerhub_Username:-mozillareality}/coturn:${CONTAINER_TAG:-stable-latest}}
#    restart: unless-stopped
##    network_mode: host
#    networks:
#      - hubs
#    ports:
#      - '5349:5349'
#    environment:
#      REALM: turkey
#      PSQL: 'postgres://${DB_USER:-postgres}:${DB_PASS:-123456}@pgbouncer/${DB_NAME:-retdb}'
#    healthcheck:
#      test: ["CMD", "nc", "-zv", "coturn", "5349"]


volumes:
  reticulum-storage:
  postgresql-data:
  certbot-etc:
  acme-challenge:

networks:
  hubs:
